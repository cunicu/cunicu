"use strict";(self.webpackChunkcunicu=self.webpackChunkcunicu||[]).push([[7579],{85179:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>p,frontMatter:()=>s,metadata:()=>c,toc:()=>l});var r=t(85893),i=t(11151);const s={},o="Proxying",c={id:"dev/proxying",title:"Proxying",description:"cun\u012bcu implements multiple ways of running an ICE agent alongside WireGuard on the same UDP ports.",source:"@site/docs/dev/proxying.md",sourceDirName:"dev",slug:"/dev/proxying",permalink:"/docs/dev/proxying",draft:!1,unlisted:!1,editUrl:"https://github.com/cunicu/cunicu/edit/main/docs/dev/proxying.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Contributions",permalink:"/docs/dev/contributions"},next:{title:"Session Signaling",permalink:"/docs/dev/signaling"}},a={},l=[{value:"Kernel WireGuard module",id:"kernel-wireguard-module",level:2},{value:"User-space",id:"user-space",level:3},{value:"RAW Sockets + BPF filter (Kernel)",id:"raw-sockets--bpf-filter-kernel",level:3},{value:"NFtables port-redirection (Kernel)",id:"nftables-port-redirection-kernel",level:3},{value:"IPTables port-redirection",id:"iptables-port-redirection",level:2},{value:"User-space WireGuard implementation",id:"user-space-wireguard-implementation",level:2},{value:"User-space Proxy",id:"user-space-proxy",level:3},{value:"In-process socket",id:"in-process-socket",level:3},{value:"Flowchart",id:"flowchart",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",...(0,i.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"proxying",children:"Proxying"}),"\n",(0,r.jsx)(n.p,{children:"cun\u012bcu implements multiple ways of running an ICE agent alongside WireGuard on the same UDP ports."}),"\n",(0,r.jsx)(n.h2,{id:"kernel-wireguard-module",children:"Kernel WireGuard module"}),"\n",(0,r.jsx)(n.h3,{id:"user-space",children:"User-space"}),"\n",(0,r.jsx)(n.p,{children:"For each WG peer a new local UDP socket is opened.\ncun\u012bcu will update the endpoint address of the peer to this the local address of the new sockets."}),"\n",(0,r.jsx)(n.p,{children:"WireGuard traffic is proxied by cun\u012bcu between the local UDP and the ICE socket."}),"\n",(0,r.jsx)(n.h3,{id:"raw-sockets--bpf-filter-kernel",children:"RAW Sockets + BPF filter (Kernel)"}),"\n",(0,r.jsxs)(n.p,{children:["We allocate a single ",(0,r.jsx)(n.a,{href:"https://squidarth.com/networking/systems/rc/2018/05/28/using-raw-sockets.html",children:"Linux RAW socket"})," and assign a ",(0,r.jsx)(n.a,{href:"https://riyazali.net/posts/berkeley-packet-filter-in-golang/",children:"eBPF"})," filter to this socket which will only match STUN traffic to a specific UDP port.\nUDP headers are parsed/produced by cun\u012bcu.\ncun\u012bcu uses a UDPMux to mux all peers ICE Agents over this single RAW socket."]}),"\n",(0,r.jsx)(n.h3,{id:"nftables-port-redirection-kernel",children:"NFtables port-redirection (Kernel)"}),"\n",(0,r.jsxs)(n.p,{children:["Two ",(0,r.jsx)(n.a,{href:"https://www.netfilter.org/projects/nftables/manpage.html",children:"Nftables"})," (nft) rules are added to filter input & output chains respectively.\nThe input rule will match all non-STUN traffic directed at the local port of the ICE candidate and rewrites the UDP destination port to the local listen port of the WireGuard interface.\nThe output rule will mach all traffic originating from the listen port of the WG interface and directed to the port of the remote candidate and rewrites the source port to the port of the local ICE candidate."]}),"\n",(0,r.jsx)(n.p,{children:"WireGuard traffic passes only through the Netfilter chains and remains inside the kernel.\nOnly STUN binding requests are passed to cun\u012bcu."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"$ sudo nft list ruleset\ntable inet cunicu {\n    chain ingress {\n        type filter hook input priority raw; policy accept;\n        udp dport 37281 @th,96,32 != 554869826 notrack udp dport set 1001\n    }\n\n    chain egress {\n        type filter hook output priority raw; policy accept;\n        udp sport 1001 udp dport 38767 notrack udp sport set 37281\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"iptables-port-redirection",children:"IPTables port-redirection"}),"\n",(0,r.jsx)(n.p,{children:"Similar to NFTables port-natting by using the legacy IPTables API."}),"\n",(0,r.jsx)(n.h2,{id:"user-space-wireguard-implementation",children:"User-space WireGuard implementation"}),"\n",(0,r.jsx)(n.h3,{id:"user-space-proxy",children:"User-space Proxy"}),"\n",(0,r.jsx)(n.p,{children:"Just like for the Kernel WireGuard module, a dedicated UDP socket for each WG peer is created.\ncun\u012bcu will update the endpoint address of the peer to this the local address of the new sockets."}),"\n",(0,r.jsx)(n.p,{children:"WireGuard traffic is proxied by cun\u012bcu between the local UDP and the ICE socket."}),"\n",(0,r.jsx)(n.h3,{id:"in-process-socket",children:"In-process socket"}),"\n",(0,r.jsxs)(n.p,{children:["cun\u012bcu implements wireguard-go's ",(0,r.jsx)(n.code,{children:"conn.Bind"})," interface to handle WireGuard's network IO."]}),"\n",(0,r.jsxs)(n.p,{children:["WireGuard traffic is passed directly between ",(0,r.jsx)(n.code,{children:"conn.Bind"})," and Pion's ",(0,r.jsx)(n.code,{children:"ice.Conn"}),".\nNo round-trip through the kernel stack is required."]}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"This variant only works for the compiled-in version of wireguard-go in cun\u012bcu."})}),"\n",(0,r.jsx)(n.h2,{id:"flowchart",children:"Flowchart"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:t(37169).Z+"",width:"874",height:"914"})})]})}function p(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},37169:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/proxy-561858b0dc7f68600875c73c14ebef67.svg"},11151:(e,n,t)=>{t.d(n,{Z:()=>c,a:()=>o});var r=t(67294);const i={},s=r.createContext(i);function o(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);